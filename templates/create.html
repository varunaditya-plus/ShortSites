<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Shortsite</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/ayu-dark.min.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/css/css.min.js"></script>
    
    <link rel="stylesheet" href="/static/editor.css">
    <style>
        /* AI Chat Formatting Styles */
        .code-block {
            background-color: #1f2937;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
            width: 100%;
            max-width: calc(100% - 20px);
            margin: 10px auto;
        }
        .code-header {
            background-color: #374151;
            color: #e5e7eb;
            font-size: 0.8rem;
            padding: 4px 10px;
            font-family: monospace;
            border-bottom: 1px solid #4b5563;
        }
        .code-block pre {
            margin: 0;
            padding: 10px;
            overflow-x: auto;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: #1f2937;
        }
        .code-block code {
            white-space: pre-wrap;
            word-break: break-all;
        }
        .inline-code {
            background-color: #374151;
            border-radius: 3px;
            padding: 2px 4px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e5e7eb;
        }
        
        /* Syntax highlighting colors */
        .language-html .keyword,
        .language-xml .keyword { color: #c678dd; }
        .language-html .tag,
        .language-xml .tag { color: #e06c75; }
        .language-html .attr,
        .language-xml .attr { color: #d19a66; }
        .language-html .string,
        .language-xml .string { color: #98c379; }
        .language-html .comment,
        .language-xml .comment { color: #7f848e; font-style: italic; }
        
        .language-css .property { color: #61afef; }
        .language-css .selector { color: #e06c75; }
        .language-css .value { color: #98c379; }
        .language-css .punctuation { color: #abb2bf; }
        .language-css .comment { color: #7f848e; font-style: italic; }
        
        .language-javascript .keyword,
        .language-js .keyword { color: #c678dd; }
        .language-javascript .string,
        .language-js .string { color: #98c379; }
        .language-javascript .number,
        .language-js .number { color: #d19a66; }
        .language-javascript .function,
        .language-js .function { color: #61afef; }
        .language-javascript .comment,
        .language-js .comment { color: #7f848e; font-style: italic; }
        
        .language-plaintext { color: #abb2bf; }
    </style>
</head>
<body class="flex flex-col md:flex-row font-sans m-0 min-h-screen text-zinc-500 bg-zinc-950">
    <main class="flex flex-col w-full">
        <div class="flex flex-col md:flex-row flex-grow w-full">
            <section class="flex-1 flex flex-col p-5 md:pr-2 pb-3 bg-background">
                <ul class="flex flex-row bkyl">
                    <li>
                        <button onclick="showTab('html')" id="html-tab" class="tab active" style="margin-left: 0; padding-left: 19px;">
                            <!-- HTML Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="w-4 h-4 inline-block mr-1 mb-0.5"><path fill="#E65100" d="m4 4 2 22 10 2 10-2 2-22Zm19.72 7H11.28l.29 3h11.86l-.802 9.335L15.99 25l-6.635-1.646L8.93 19h3.02l.19 2 3.86.77 3.84-.77.29-4H8.84L8 8h16Z"/></svg>
                            index.html
                        </button>
                    </li>
                    <li>
                        <button onclick="showTab('css')" id="css-tab" class="tab">
                            <!-- CSS Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="w-4 h-4 inline-block mr-1 mb-0.5"><path fill="#42a5f5" d="m29.18 4-3.57 18.36-.33 1.64-4.74 1.57-3.28 1.09L13.21 28 2.87 24.05 4.05 18h4.2l-.44 2.85 6.34 2.42.78-.26 6.52-2.16.17-.83.79-4.02H4.44l.74-3.76.05-.24h17.96l.78-4H6l.78-4h22.4z"/></svg>
                            styles.css
                        </button>
                    </li>
                    <li>
                        <button onclick="showTab('js')" id="js-tab" class="tab">
                            <!-- JS Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" class="w-4 h-4 inline-block mr-1 mb-0.5"><path fill="#ffca28" d="M2 2h12v12H2V2m3.153 10.027c.267.567.794 1.033 1.694 1.033 1 0 1.686-.533 1.686-1.7V7.507H7.4v3.827c0 .573-.233.72-.6.72-.387 0-.547-.267-.727-.58l-.92.553m3.987-.12c.333.653 1.007 1.153 2.06 1.153 1.067 0 1.867-.553 1.867-1.573 0-.94-.54-1.36-1.5-1.773l-.28-.12c-.487-.207-.694-.347-.694-.68 0-.274.207-.487.54-.487.32 0 .534.14.727.487l.873-.58c-.366-.64-.886-.887-1.6-.887-1.006 0-1.653.64-1.653 1.487 0 .92.54 1.353 1.353 1.7l.28.12c.52.226.827.366.827.753 0 .32-.3.553-.767.553-.553 0-.873-.286-1.113-.686z"/></svg>
                            script.js
                        </button>
                    </li>
                    <li class="flex-grow tab no-hover"></li>
                </ul>

                <!-- HTML Editor -->
                <div id="html-editor-container" class="editor-container">
                    <div id="html-editor" class="w-full h-48 md:h-64 border border-input"></div>
                </div>

                <!-- CSS Editor -->
                <div id="css-editor-container" class="editor-container hidden">
                    <div id="css-editor" class="w-full h-48 md:h-64 border border-input"></div>
                </div>

                <!-- JS Editor -->
                <div id="js-editor-container" class="editor-container hidden">
                    <div id="js-editor" class="w-full h-48 md:h-64 border border-input"></div>
                </div>
            </section>

            <section id="preview" class="flex-1 bg-muted md:w-1/2 py-3 px-5 md:pl-2 md:pt-5 flex flex-col">
                <iframe id="preview-frame" class="w-full h-[20vh] md:h-[50%] border-none bg-white shadow-md mb-3" title="Live Preview"></iframe>
                
                <!-- AI Chatbot Section -->
                <div class="w-full h-[20vh] md:h-[50%] bg-zinc-900 rounded shadow-md flex flex-col">
                    <div class="bg-zinc-800 p-2 text-zinc-300 font-medium flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v-4"></path>
                            <path d="M12 8h.01"></path>
                        </svg>
                        <span>AI Assistant</span>
                    </div>
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-3 space-y-2 text-sm"></div>
                    <div class="p-2 border-t border-zinc-800 flex">
                        <input id="chat-input" type="text" placeholder="Ask the AI for help with your site..." 
                               class="flex-grow bg-zinc-800 text-zinc-300 p-2 rounded-l outline-none border-none" 
                               onkeydown="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="bg-[#c084fc] hover:bg-[#c997fb] text-[#0b0e14] font-semibold p-2 rounded-r">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        </div>
        <div class="flex justify-start p-5 bg-background pt-0">
            <button onclick="saveSite()" class="bg-[#c084fc] hover:bg-[#c997fb] hover:scale-105 text-[#0b0e14] font-semibold py-1 px-4 transition duration-200 flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span>Save</span>
            </button>
        </div>
    </main>

    <div id="message-modal" class="bkmdl text-white p-4 inline-block w-1/2" style="top: 50%; left: 50%; transform: translate(-50%, -50%); position: absolute; display:none; z-index: 9999;">
        <h1 id="message-title" class="text-center text-xl h1mdl"></h1>
        <p id="message-content" class="text-center"></p>
        <button onclick="hideMessageModal()" class="absolute top-3.5 right-5 p-1 closemdl">âœ•</button>
    </div>

    <script>
        let htmlEditor, cssEditor, jsEditor;

        // Add the chat functionality
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input
            input.value = '';
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Show loading indicator
            const loadingId = 'loading-message-' + Date.now();
            addMessageToChat('assistant', '...', loadingId);
            
            // Get current code from editors
            const html = htmlEditor.getValue();
            const css = cssEditor.getValue();
            const js = jsEditor.getValue();
            
            // Create a message container for the AI response
            const chatMessages = document.getElementById('chat-messages');
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'p-2 rounded bg-zinc-700 mr-8';
            aiMessageDiv.id = 'ai-response-' + Date.now();
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'font-bold';
            iconSpan.textContent = 'AI: ';
            
            const contentSpan = document.createElement('span');
            contentSpan.id = 'ai-content-' + Date.now();
            contentSpan.textContent = '';
            
            aiMessageDiv.appendChild(iconSpan);
            aiMessageDiv.appendChild(contentSpan);
            
            document.getElementById(loadingId)?.remove();
            chatMessages.appendChild(aiMessageDiv);
            
            fetch('/ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    html: html,
                    css: css,
                    js: js
                }),
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';
                
                function processStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // Format the complete response when stream is done
                            contentSpan.innerHTML = formatAIResponse(fullResponse);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            return;
                        }
                        
                        // Decode the chunk and add it to our buffer
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // Process complete SSE messages in the buffer
                        let lines = buffer.split('\n\n');
                        buffer = lines.pop() || ''; // Keep the last incomplete chunk in the buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    
                                    if (data.content === '[DONE]') {
                                        return; // End of stream
                                    }
                                    
                                    // Add to full response
                                    fullResponse += data.content;
                                    
                                    // Update with formatted content
                                    contentSpan.innerHTML = formatAIResponse(fullResponse);
                                    
                                    // Scroll to bottom
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e);
                                }
                            }
                        }
                        
                        // Continue reading
                        return processStream();
                    });
                }
                
                return processStream();
            })
            .catch(error => {
                console.error('Error with AI request:', error);
                contentSpan.innerHTML += "<br>[Error: Could not connect to AI service]";
            });
        }
        
        // Format AI response with syntax highlighting and markdown-like features
        function formatAIResponse(text) {
            if (!text) return '';
            
            // Replace line breaks with <br>
            let formatted = text.replace(/\n/g, '<br>');
            
            // Format code blocks with syntax highlighting
            formatted = formatted.replace(/```(\w+)?\s*([\s\S]*?)\s*```/g, function(match, language, code) {
                language = language || 'plaintext';
                
                // Apply syntax highlighting based on language
                let highlightedCode = code;
                
                if (language === 'css') {
                    // CSS syntax highlighting
                    highlightedCode = highlightCSS(escapeHtml(code));
                } else if (language === 'html' || language === 'xml') {
                    // HTML syntax highlighting
                    highlightedCode = highlightHTML(escapeHtml(code));
                } else if (language === 'javascript' || language === 'js') {
                    // JavaScript syntax highlighting
                    highlightedCode = highlightJS(escapeHtml(code));
                } else {
                    // Plain text
                    highlightedCode = escapeHtml(code);
                }

                return `<pre><code class="language-${language}">${highlightedCode}</code></pre>`;
            });
            
            // Format inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            return formatted;
        }
        
        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function addMessageToChat(role, content, id = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-2 rounded ${role === 'user' ? 'bg-zinc-800 ml-8' : 'bg-zinc-700 mr-8'}`;
            if (id) messageDiv.id = id;
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'font-bold';
            iconSpan.textContent = role === 'user' ? 'You: ' : 'AI: ';
            
            const contentSpan = document.createElement('span');
            contentSpan.textContent = content;
            
            messageDiv.appendChild(iconSpan);
            messageDiv.appendChild(contentSpan);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Initialize CodeMirror editors
            const commonOptions = {
                lineNumbers: true,
                theme: 'ayu-dark',
                tabSize: 2,
                indentWithTabs: false,
                styleActiveLine: true,
                matchBrackets: true,
            };

            htmlEditor = CodeMirror(document.getElementById('html-editor'), {
                ...commonOptions,
                value: `<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Untitled ShortSite</title>\n    <style do-not-remove>[[_CSS_]]</style>\n</head>\n<body>\n    <h1>Write your html here</h1>\n    <!-- Add more HTML here -->\n\n    <script do-not-remove>[[_JS_]]<\/script>\n</body>\n</html>`,
                mode: 'htmlmixed'
            });

            cssEditor = CodeMirror(document.getElementById('css-editor'), {
                ...commonOptions,
                value: `body {\n    background-color: #0f0f11;\n    color: #fff;\n    font-family: Arial, Helvetica, sans-serif;\n    text-align: center;\n}\n\n/* Add more CSS here... */`,
                mode: 'css'
            });

            jsEditor = CodeMirror(document.getElementById('js-editor'), {
                ...commonOptions,
                value: '// Write your JavaScript here',
                mode: 'javascript'
            });

            function updatePreview() {
                const html = htmlEditor.getValue();
                const css = `<style>${cssEditor.getValue()}</style>`;
                const js = `<script>${jsEditor.getValue()}<\/script>`;
                const content = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Preview</title>
                        ${css}
                    </head>
                    <body>
                        ${html}
                        ${js}
                    </body>
                    </html>
                `;
                const previewFrame = document.getElementById('preview-frame');
                const previewDocument = previewFrame.contentDocument || previewFrame.contentWindow.document;
                previewDocument.open();
                previewDocument.write(content);
                previewDocument.close();
            }

            htmlEditor.on("change", updatePreview);
            cssEditor.on("change", updatePreview);
            jsEditor.on("change", updatePreview);

            updatePreview();

            window.saveSite = function () {
                const html = htmlEditor.getValue();
                const css = cssEditor.getValue();
                const js = jsEditor.getValue();

                const formData = new URLSearchParams();
                formData.append('html', html);
                formData.append('css', css);
                formData.append('js', js);

                fetch('/uploadsite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData,
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) {
                        showMessageModal('Error', 'An error occurred while saving your ShortSite.');
                    } else {
                        showMessageModal('', `
                            <p class="!mt-3 !mb-4">Your site is now published. Check it out at <a href="${data.link}" target="_blank" class="text-blue-400 underline">${data.link}</a></p>
                            <p class="bg-zinc-800 p-2 rounded font-mono !mb-1 cursor-pointer" onclick="navigator.clipboard.writeText('${data.access_key}'); alert('Your key has been copied to clipboard.')">Your access key is <span class="text-red-400">${data.access_key}</span></p>
                            <p class="!mb-1 !text-sm !text-left text-red-500">KEEP THIS SOMEWHERE SAFE. THIS IS USED TO MAKE EDITS TO YOUR SITE.</p>
                        `);
                    }
                });
            };

            function showMessageModal(title, content) {
                const modal = document.getElementById('message-modal');
                const modalTitle = document.getElementById('message-title');
                const modalContent = document.getElementById('message-content');
                const mainElement = document.querySelector('main');

                modalTitle.textContent = title;
                modalTitle.style.display = title ? 'block' : 'none';
                modalContent.innerHTML = content;
                modal.style.display = 'block';
                
                mainElement.classList.add('opacity-70', 'blur-sm');
            }

            window.hideMessageModal = function() {
                const modal = document.getElementById('message-modal');
                const mainElement = document.querySelector('main');
                
                modal.style.display = 'none';
                
                mainElement.classList.remove('opacity-70', 'blur-sm');
            }

            window.showTab = function(editor) {
                document.querySelectorAll('.editor-container').forEach(container => container.classList.add('hidden'));
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

                document.getElementById(editor + '-editor-container').classList.remove('hidden');
                document.getElementById(editor + '-tab').classList.add('active');
                
                if (editor === 'html') htmlEditor.refresh();
                if (editor === 'css') cssEditor.refresh();
                if (editor === 'js') jsEditor.refresh();
            }
        });
    </script>
</body>
</html>
